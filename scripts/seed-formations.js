// Script d'insertion de 10 enregistrements réalistes dans la table `Formations`
// Utilise DATABASE_URL si disponible, sinon bascule sur la configuration locale par défaut.
// Exécution: node scripts/seed-formations.js

const mysql = require('mysql2/promise')

async function getConnection() {
  const url = process.env.DATABASE_URL
  if (url) {
    const match = url.match(/^mysql:\/\/([^:]+):([^@]+)@([^:\/]+)(?::(\d+))?\/(.+)$/)
    if (!match) {
      throw new Error('DATABASE_URL invalide. Attendu: mysql://user:pass@host:port/db')
    }
    const [_, user, password, host, port, database] = match
    return mysql.createConnection({ host, user, password, database, port: port ? Number(port) : 3306 })
  }
  const host = process.env.MYSQL_HOST || 'localhost'
  const user = process.env.MYSQL_USER || 'root'
  const password = process.env.MYSQL_PASSWORD || ''
  const database = process.env.MYSQL_DATABASE || 'windevexpert_platform'
  const port = Number(process.env.MYSQL_PORT || 3306)
  return mysql.createConnection({ host, user, password, database, port })
}

function formationsData() {
  return [
    {
      id_formation: 'FORM-0001',
      titre: 'JavaScript Moderne et Node.js',
      sous_titre: 'De ES6+ à Node.js en production',
      description_courte: 'Maîtrisez JS moderne, l’écosystème Node et les bonnes pratiques.',
      description_complete: 'Cette formation couvre les bases et avancés de JavaScript moderne (ES6+), les patterns asynchrones, Node.js, NPM, et la mise en production de services. Exercices et projets inclus.',
      langue: 'FRANCAIS',
      categorie: 'DEVELOPPEMENT_WEB',
      sous_categorie: 'JAVASCRIPT',
      objectifs_apprentissage: JSON.stringify(['ES6+', 'Async/Await', 'Node.js', 'NPM', 'Tests']),
      duree_totale_heures: 14.5,
      nombre_modules: 8,
      nombre_lecons: 42,
      certificat_fin_formation: true,
      niveau_requis: 'INTERMEDIAIRE',
      prerequis: 'Bases de la programmation et du JavaScript.',
      public_cible: 'Développeurs front/back souhaitant consolider JS et Node.',
      prix_usd: 129.99,
      prix_eur: 119.99,
      prix_dzd: 22000,
      prix_afr: 149.99,
      type_acces: 'ACCES_A_VIE',
      garantie_remboursement_jours: 14,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/js-node-intro.mp4',
      mots_cles: JSON.stringify(['JavaScript', 'Node.js', 'Async', 'NPM']),
      url_slug: 'javascript-moderne-nodejs',
      statut: 'PUBLIE',
      note_moyenne: 4.6,
      nombre_avis: 128,
    },
    {
      id_formation: 'FORM-0002',
      titre: 'React et Next.js pour Applications Web',
      sous_titre: 'Construisez des apps performantes avec SSR et SSG',
      description_courte: 'De React hooks à Next.js 15, optimisations et déploiement.',
      description_complete: 'Apprenez les hooks avancés, la gestion d’état, Next.js (routing, data fetching), l’optimisation et le déploiement. Bonnes pratiques et patterns.',
      langue: 'FRANCAIS',
      categorie: 'DEVELOPPEMENT_WEB',
      sous_categorie: 'JAVASCRIPT',
      objectifs_apprentissage: JSON.stringify(['React Hooks', 'Next.js', 'SSR', 'SSG', 'Optimisation']),
      duree_totale_heures: 16.0,
      nombre_modules: 10,
      nombre_lecons: 55,
      certificat_fin_formation: true,
      niveau_requis: 'INTERMEDIAIRE',
      prerequis: 'Connaissances de base en React et JS.',
      public_cible: 'Développeurs front-end souhaitant monter en performance.',
      prix_usd: 149.99,
      prix_eur: 139.99,
      prix_dzd: 25000,
      prix_afr: 169.99,
      type_acces: 'ABONNEMENT_1_AN',
      garantie_remboursement_jours: 30,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/react-nextjs.mp4',
      mots_cles: JSON.stringify(['React', 'Next.js', 'SSR', 'SSG']),
      url_slug: 'react-nextjs-applications-web',
      statut: 'PUBLIE',
      note_moyenne: 4.7,
      nombre_avis: 96,
    },
    {
      id_formation: 'FORM-0003',
      titre: 'SEO Technique pour Développeurs',
      sous_titre: 'Rendre les sites performants et indexables',
      description_courte: 'Core Web Vitals, indexation, sitemaps, robots et logs.',
      description_complete: 'Focus sur le SEO technique: performances, indexation, render/CSR/SSR, sitemaps, robots.txt, logs, maillage interne et monitoring.',
      langue: 'FRANCAIS',
      categorie: 'MARKETING',
      sous_categorie: 'SEO',
      objectifs_apprentissage: JSON.stringify(['Core Web Vitals', 'Indexation', 'Sitemaps', 'Robots']),
      duree_totale_heures: 9.5,
      nombre_modules: 6,
      nombre_lecons: 30,
      certificat_fin_formation: true,
      niveau_requis: 'INTERMEDIAIRE',
      prerequis: 'Notions de HTML/CSS/JS et web performance.',
      public_cible: 'Développeurs et SEO techniques.',
      prix_usd: 119.99,
      prix_eur: 109.99,
      prix_dzd: 20000,
      prix_afr: 139.99,
      type_acces: 'ACCES_A_VIE',
      garantie_remboursement_jours: 14,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/seo-technique.mp4',
      mots_cles: JSON.stringify(['SEO', 'Performance', 'Indexation']),
      url_slug: 'seo-technique-developpeurs',
      statut: 'PUBLIE',
      note_moyenne: 4.5,
      nombre_avis: 64,
    },
    {
      id_formation: 'FORM-0004',
      titre: 'Marketing Digital: Stratégies de Contenu',
      sous_titre: 'De la recherche à la conversion',
      description_courte: 'Méthodologies, calendrier éditorial, KPI et ROI.',
      description_complete: 'Apprenez à concevoir des stratégies de contenu efficaces: personae, calendrier, formats, distribution, KPI, mesure et amélioration continue.',
      langue: 'FRANCAIS',
      categorie: 'MARKETING',
      sous_categorie: 'SEO',
      objectifs_apprentissage: JSON.stringify(['Content Strategy', 'KPI', 'ROI']),
      duree_totale_heures: 8.0,
      nombre_modules: 5,
      nombre_lecons: 24,
      certificat_fin_formation: false,
      niveau_requis: 'DEBUTANT',
      prerequis: 'Aucun, notions de communication utiles.',
      public_cible: 'Marketeurs, créateurs de contenu, entrepreneurs.',
      prix_usd: 89.99,
      prix_eur: 79.99,
      prix_dzd: 15000,
      prix_afr: 99.99,
      type_acces: 'ABONNEMENT_1_AN',
      garantie_remboursement_jours: 7,
      image_couverture_url: null,
      video_presentation_url: null,
      mots_cles: JSON.stringify(['Marketing', 'Contenu', 'KPI']),
      url_slug: 'marketing-digital-strategies-contenu',
      statut: 'PUBLIE',
      note_moyenne: 4.3,
      nombre_avis: 38,
    },
    {
      id_formation: 'FORM-0005',
      titre: 'TypeScript Avancé et Patterns',
      sous_titre: 'Génériques, types utilitaires et architecture',
      description_courte: 'Améliorez la robustesse de vos apps TS.',
      description_complete: 'Comprenez les types avancés, les génériques, les mapped types, l’inférence et les patterns d’architecture pour apps front/back.',
      langue: 'ANGLAIS',
      categorie: 'DEVELOPPEMENT_WEB',
      sous_categorie: 'JAVASCRIPT',
      objectifs_apprentissage: JSON.stringify(['Generics', 'Utility Types', 'Architecture Patterns']),
      duree_totale_heures: 11.0,
      nombre_modules: 7,
      nombre_lecons: 33,
      certificat_fin_formation: true,
      niveau_requis: 'AVANCE',
      prerequis: 'Bonne maîtrise de JS/TS.',
      public_cible: 'Dev front/back cherchant du typage avancé.',
      prix_usd: 139.99,
      prix_eur: 129.99,
      prix_dzd: 23000,
      prix_afr: 159.99,
      type_acces: 'ACCES_A_VIE',
      garantie_remboursement_jours: 30,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/typescript-avance.mp4',
      mots_cles: JSON.stringify(['TypeScript', 'Generics', 'Patterns']),
      url_slug: 'typescript-avance-patterns',
      statut: 'PUBLIE',
      note_moyenne: 4.8,
      nombre_avis: 72,
    },
    {
      id_formation: 'FORM-0006',
      titre: 'Performance Web et Optimisation SEO',
      sous_titre: 'Perf côté client et SEO gagnant',
      description_courte: 'Profiling, lazy loading, images, et bonnes pratiques techniques.',
      description_complete: 'Mesurez et améliorez la performance web (Lighthouse, WebPageTest), optimisez images, assets, rendu et impacts SEO.',
      langue: 'FRANCAIS',
      categorie: 'MARKETING',
      sous_categorie: 'SEO',
      objectifs_apprentissage: JSON.stringify(['Performance', 'Lighthouse', 'Lazy Loading']),
      duree_totale_heures: 7.5,
      nombre_modules: 5,
      nombre_lecons: 22,
      certificat_fin_formation: false,
      niveau_requis: 'DEBUTANT',
      prerequis: 'Bases du web recommandées.',
      public_cible: 'Dev et SEO débutants/intermédiaires.',
      prix_usd: 79.99,
      prix_eur: 74.99,
      prix_dzd: 12000,
      prix_afr: 89.99,
      type_acces: 'ABONNEMENT_1_AN',
      garantie_remboursement_jours: 7,
      image_couverture_url: null,
      video_presentation_url: null,
      mots_cles: JSON.stringify(['SEO', 'Perf', 'Images']),
      url_slug: 'performance-web-optimisation-seo',
      statut: 'PUBLIE',
      note_moyenne: 4.2,
      nombre_avis: 41,
    },
    {
      id_formation: 'FORM-0007',
      titre: 'Création d’APIs REST avec Express',
      sous_titre: 'De la conception à la sécurisation',
      description_courte: 'Express, middlewares, auth et tests.',
      description_complete: 'Concevez des APIs REST avec Express, gérez la validation, la sécurité (JWT), la documentation, les tests et le déploiement.',
      langue: 'ANGLAIS',
      categorie: 'DEVELOPPEMENT_WEB',
      sous_categorie: 'JAVASCRIPT',
      objectifs_apprentissage: JSON.stringify(['Express', 'JWT', 'Validation', 'Tests']),
      duree_totale_heures: 10.0,
      nombre_modules: 6,
      nombre_lecons: 28,
      certificat_fin_formation: true,
      niveau_requis: 'INTERMEDIAIRE',
      prerequis: 'Connaissances Node.js et HTTP.',
      public_cible: 'Développeurs back-end et full-stack.',
      prix_usd: 129.99,
      prix_eur: 119.99,
      prix_dzd: 22000,
      prix_afr: 149.99,
      type_acces: 'ACCES_A_VIE',
      garantie_remboursement_jours: 14,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/apis-express.mp4',
      mots_cles: JSON.stringify(['Express', 'REST', 'JWT']),
      url_slug: 'apis-rest-express',
      statut: 'PUBLIE',
      note_moyenne: 4.4,
      nombre_avis: 58,
    },
    {
      id_formation: 'FORM-0008',
      titre: 'Growth Marketing et Analytics',
      sous_titre: 'De l’acquisition à la rétention',
      description_courte: 'Frameworks, analytics, funnels et expérimentation.',
      description_complete: 'Apprenez le growth: AARRR, analytics, funnels, A/B testing, et outils de tracking pour optimiser acquisition et rétention.',
      langue: 'FRANCAIS',
      categorie: 'MARKETING',
      sous_categorie: 'SEO',
      objectifs_apprentissage: JSON.stringify(['AARRR', 'Analytics', 'A/B Testing']),
      duree_totale_heures: 8.5,
      nombre_modules: 6,
      nombre_lecons: 26,
      certificat_fin_formation: false,
      niveau_requis: 'DEBUTANT',
      prerequis: 'Notions de marketing souhaitées.',
      public_cible: 'Marketeurs et fondateurs.',
      prix_usd: 99.99,
      prix_eur: 89.99,
      prix_dzd: 16000,
      prix_afr: 119.99,
      type_acces: 'ABONNEMENT_1_AN',
      garantie_remboursement_jours: 14,
      image_couverture_url: null,
      video_presentation_url: null,
      mots_cles: JSON.stringify(['Analytics', 'Growth', 'Funnels']),
      url_slug: 'growth-marketing-analytics',
      statut: 'PUBLIE',
      note_moyenne: 4.1,
      nombre_avis: 33,
    },
    {
      id_formation: 'FORM-0009',
      titre: 'Front-end Testing avec Jest et Playwright',
      sous_titre: 'Tests unitaires et end-to-end',
      description_courte: 'Qualité logicielle côté front.',
      description_complete: 'Mettez en place une stratégie de tests front complète: Jest, React Testing Library, Playwright, CI et coverage.',
      langue: 'ANGLAIS',
      categorie: 'DEVELOPPEMENT_WEB',
      sous_categorie: 'JAVASCRIPT',
      objectifs_apprentissage: JSON.stringify(['Jest', 'RTL', 'Playwright', 'CI']),
      duree_totale_heures: 9.0,
      nombre_modules: 6,
      nombre_lecons: 27,
      certificat_fin_formation: true,
      niveau_requis: 'INTERMEDIAIRE',
      prerequis: 'Bases React et JS.',
      public_cible: 'Dev front cherchant qualité et fiabilité.',
      prix_usd: 119.99,
      prix_eur: 109.99,
      prix_dzd: 20000,
      prix_afr: 139.99,
      type_acces: 'ACCES_A_VIE',
      garantie_remboursement_jours: 30,
      image_couverture_url: null,
      video_presentation_url: 'https://example.com/videos/testing-front.mp4',
      mots_cles: JSON.stringify(['Testing', 'Jest', 'Playwright']),
      url_slug: 'frontend-testing-jest-playwright',
      statut: 'PUBLIE',
      note_moyenne: 4.6,
      nombre_avis: 59,
    },
    {
      id_formation: 'FORM-0010',
      titre: 'SEO Local et E-commerce',
      sous_titre: 'Boostez la visibilité et les ventes',
      description_courte: 'Stratégies locales, fiches et catalogues produits.',
      description_complete: 'Optimisez votre présence locale et e-commerce: Google Business, avis, fiches produits, schema.org, et SEO on-site.',
      langue: 'FRANCAIS',
      categorie: 'MARKETING',
      sous_categorie: 'SEO',
      objectifs_apprentissage: JSON.stringify(['SEO Local', 'E-commerce', 'Schema.org']),
      duree_totale_heures: 7.0,
      nombre_modules: 5,
      nombre_lecons: 21,
      certificat_fin_formation: false,
      niveau_requis: 'DEBUTANT',
      prerequis: 'Aucun requis.',
      public_cible: 'Commerçants et responsables marketing.',
      prix_usd: 89.99,
      prix_eur: 79.99,
      prix_dzd: 15000,
      prix_afr: 99.99,
      type_acces: 'ABONNEMENT_1_AN',
      garantie_remboursement_jours: 7,
      image_couverture_url: null,
      video_presentation_url: null,
      mots_cles: JSON.stringify(['Local', 'Avis', 'Produits']),
      url_slug: 'seo-local-ecommerce',
      statut: 'PUBLIE',
      note_moyenne: 4.0,
      nombre_avis: 27,
    },
  ]
}

async function main() {
  const conn = await getConnection()
  const data = formationsData()

  const insertSql = `
    INSERT INTO Formations (
      id_formation, titre, sous_titre, description_courte, description_complete,
      langue, categorie, sous_categorie,
      objectifs_apprentissage, duree_totale_heures, nombre_modules, nombre_lecons, certificat_fin_formation,
      niveau_requis, prerequis, public_cible,
      prix_usd, prix_eur, prix_dzd, prix_afr, type_acces, garantie_remboursement_jours,
      image_couverture_url, video_presentation_url, mots_cles, url_slug,
      statut, note_moyenne, nombre_avis, date_mise_a_jour
    ) VALUES (
      ?, ?, ?, ?, ?,
      ?, ?, ?,
      ?, ?, ?, ?, ?,
      ?, ?, ?,
      ?, ?, ?, ?, ?, ?,
      ?, ?, ?, ?,
      ?, ?, ?, NOW()
    )
    ON DUPLICATE KEY UPDATE
      titre = VALUES(titre),
      sous_titre = VALUES(sous_titre),
      description_courte = VALUES(description_courte),
      description_complete = VALUES(description_complete),
      langue = VALUES(langue),
      categorie = VALUES(categorie),
      sous_categorie = VALUES(sous_categorie),
      objectifs_apprentissage = VALUES(objectifs_apprentissage),
      duree_totale_heures = VALUES(duree_totale_heures),
      nombre_modules = VALUES(nombre_modules),
      nombre_lecons = VALUES(nombre_lecons),
      certificat_fin_formation = VALUES(certificat_fin_formation),
      niveau_requis = VALUES(niveau_requis),
      prerequis = VALUES(prerequis),
      public_cible = VALUES(public_cible),
      prix_usd = VALUES(prix_usd),
      prix_eur = VALUES(prix_eur),
      prix_dzd = VALUES(prix_dzd),
      prix_afr = VALUES(prix_afr),
      type_acces = VALUES(type_acces),
      garantie_remboursement_jours = VALUES(garantie_remboursement_jours),
      image_couverture_url = VALUES(image_couverture_url),
      video_presentation_url = VALUES(video_presentation_url),
      mots_cles = VALUES(mots_cles),
      url_slug = VALUES(url_slug),
      statut = VALUES(statut),
      note_moyenne = VALUES(note_moyenne),
      nombre_avis = VALUES(nombre_avis),
      date_mise_a_jour = NOW()
  `

  let inserted = 0
  for (const f of data) {
    const params = [
      f.id_formation, f.titre, f.sous_titre, f.description_courte, f.description_complete,
      f.langue, f.categorie, f.sous_categorie,
      f.objectifs_apprentissage, f.duree_totale_heures, f.nombre_modules, f.nombre_lecons, f.certificat_fin_formation,
      f.niveau_requis, f.prerequis, f.public_cible,
      f.prix_usd, f.prix_eur, f.prix_dzd, f.prix_afr, f.type_acces, f.garantie_remboursement_jours,
      f.image_couverture_url, f.video_presentation_url, f.mots_cles, f.url_slug,
      f.statut, f.note_moyenne, f.nombre_avis
    ]
    const [res] = await conn.execute(insertSql, params)
    inserted++
  }

  const [rows] = await conn.execute('SELECT COUNT(*) AS total FROM Formations')
  const total = Array.isArray(rows) ? rows[0].total : rows.total
  console.log(`✅ Insertion terminée: ${inserted} enregistrements traités. Total en base: ${total}`)
  await conn.end()
}

main().catch((err) => {
  console.error('❌ Erreur lors de l\'insertion des formations:', err)
  process.exit(1)
})